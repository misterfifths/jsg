<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script type="text/javascript" src="jquery.min.js" />

<script type="text/javascript" src="../build/jsg.js" />
<script type="text/javascript">
<![CDATA[

function timeit() {
    function test1(N) {
        function log2(x, y) { return Math.log(x) / Math.LN2; }
        function f1(x, y) { return Math.pow(log2(x, y), 2) / (x * y); };
        
        console.log(f1(2, 3));
    
        var s = new Date().getTime(), e;
        
        for(var i = 0; i < N; i++)
            f1(2, 3);
            
        e = new Date().getTime();
        
        $('#res').text(e - s);
    }
    
    function test2(N) {
        var f2 = JSG.Expr.compile('x', 'y', 'log2(x)^2/(xy)');
        console.log(f2.toString());
        
        console.log(f2(2, 3));
        
        var s = new Date().getTime(), e;
        
        for(var i = 0; i < N; i++)
            f2(2, 3);
            
        e = new Date().getTime();
        
        $('#fn').text(e - s);
    };
    
    //console.log(f1(2, 3) + ' == ' + f2(2, 3));
    
    var N = 10000000;
    test1(N);
    test2(N);
}

function init() {
	$('#frm').submit(function(e) {
		e.preventDefault();
	
		var vars = $('#vars').val().split(','),
			vals = $('#vals').val().split(','),
			env = JSG.Expr.Environment(vars,
			        !$('#autoParens').prop('checked'),
			        !$('#implicitMul').prop('checked'),
					!$('#powOp').prop('checked')),
			f,
			res;
		
		for(var i = 0; i < vals.length; i++)
		    vals[i] = parseFloat(vals[i]);
		
		// Add a sample n-arity function for kicks
		var sumFn = function() {
			var sum = 0;
			for(var i = 0; i < arguments.length; i++)
				sum += arguments[i];
			
			return sum;
		};
		sumFn.lengthIsMinimum = true;
		env.addFn('sum', sumFn);
			
		try {
			var f = JSG.Expr.compile(env, $('#expr').val()),
                res = f.apply(null, vals);
            
			$('#res').text(res);
			$('#fn').text(f.toString());
		}
		catch(exc) {
			$('#res').text('Error: ' + exc.message);
		}
	});
	
	$('#time').click(function(e) {
	    timeit();
	});
}

$(init);

]]>
</script>
</head>
<body>
<form id='frm'>
<label for="vars">Variables </label><input id="vars" value="x,y" /><br />
<label for="expr">Expression </label><input id="expr" value="2xy" /><br />
<label for="vals">Values </label><input id="vals" value="2, 4" /><br />
<fieldset>
	<legend>Options</legend>
	<input type="checkbox" id="autoParens" checked="checked" />
	<label for="autoParens">Automatic parenthesis closure</label><br />
	<input type="checkbox" id="implicitMul" checked="checked" />
	<label for="implicitMul">Implicit multiplication</label><br/>
	<input type="checkbox" id="powOp" checked="checked" />
	<label for="powOp">Exponentiation operator (^)</label><br/>
</fieldset>
<br />
<input type="submit" value="Evaluate" id="go" /><br /><br />
<input type="button" value="Time test" id="time" />
</form>
<br />
<div id="res" />
<div id="fn" />
</body>
</html>