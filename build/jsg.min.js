'use strict';var JSG=function(){function G(a,b){var c={},d;for(d in b)b.hasOwnProperty(d)&&(c[d]=a&&a.hasOwnProperty(d)?a[d]:b[d]);return c}var i=function(a,b){if(!(this instanceof i))return new i(a,b);this.name=a;this.length=b;this.nondeterministic=this.lengthIsMinimum=!1},e=function(a,b,c){if(!(this instanceof e))return new e(a,b,c);c=G(c,{lengthIsMinimum:!1,nondeterministic:!1});this.name=a;this.length=b;this.lengthIsMinimum=c.lengthIsMinimum;this.nondeterministic=c.nondeterministic};i.prototype.toString=
e.prototype.toString=function(){return this.name};var h,y=function(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},H=function(a,b){if(!a.isValidId(b))throw Error("Invalid ID: "+b);if(a.isKnownId(b))throw Error("ID "+b+" is already in use");},L=function(a,b,c){if("string"!=typeof b||1!=b.length||" "==b)throw Error("Operators IDs be a single, non-space character");if(a.isKnownId(b))throw Error("Operator ID "+b+" is already in use");if(2!=c.length)throw Error("Operators must take exactly 2 arguments");
},z=function(a,b){if(!(this instanceof z))return new z(a,b);this.options=G(b,{autoParens:!0,implicitMul:!0,powOp:!0});this.fns=y(M);this.consts=y(N);this.addOps=y(O);this.mulOps=y(P);this._implicitMulOpId="*";this._subtractOpId="-";this._negate=i("-",1);this._pow=e("Math.pow",2);this._powOpId="^";this.vars=[];a&&this.setVars(a)},M,N,O,P;M={sin:e("Math.sin",1),cos:e("Math.cos",1),tan:e("Math.tan",1),asin:e("Math.asin",1),arcsin:e("Math.asin",1),acos:e("Math.acos",1),arccos:e("Math.acos",1),atan:e("Math.atan",
1),arctan:e("Math.atan",1),atan2:e("Math.atan2",2),arctan2:e("Math.atan2",2),exp:e("Math.exp",1),sqrt:e("Math.sqrt",1),pow:e("Math.pow",2),log:e("Math.log",1),ln:e("Math.log",1),log10:function(a){return Math.log(a)/Math.LN10},log2:function(a){return Math.log(a)/Math.LN2},logn:function(a,b){return Math.log(b)/Math.log(a)},max:e("Math.max",2,{lengthIsMinimum:!0}),min:e("Math.min",2,{lengthIsMinimum:!0}),abs:e("Math.abs",1),floor:e("Math.floor",1),ceil:e("Math.ceil",1),ceiling:e("Math.ceil",1),round:e("Math.round",
1),random:e("Math.random",0,{nondeterministic:!0}),rnd:e("Math.random",0,{nondeterministic:!0}),rand:e("Math.random",0,{nondeterministic:!0}),mod:i("%",2)};N={e:Math.E,ln10:Math.LN10,log10:Math.LN10,ln2:Math.LN2,log2:Math.LN2,log10e:Math.LOG10E,log2e:Math.LOG2E,pi:Math.PI,sqrt1_2:Math.SQRT1_2,sqrt2:Math.SQRT2};O={"+":i("+",2),"-":i("-",2)};P={"*":i("*",2),"/":i("/",2),"%":i("%",2)};var f=z.prototype;f.setVars=function(a){for(var b=0;b<a.length;b++)H(this,a[b]);this.vars=a.slice()};f.addFn=function(a,
b){H(this,a);this.fns[a]=b};f.removeFn=function(a){delete this.fns[a]};f.addConst=function(a,b){H(this,a);this.consts[a]=b};f.removeConst=function(a){delete this.consts[a]};f.addAddOp=function(a,b){L(this,a,b);this.addOps[a]=b};f.removeAddOp=function(a){delete this.addOps[a]};f.addMulOp=function(a,b){L(this,a,b);this.mulOps[a]=b};f.removeMulOp=function(a){delete this.mulOps[a]};f.isVarName=function(a){for(var b=0;b<this.vars.length;b++)if(this.vars[b]==a)return!0};f.isFnName=function(a){return this.fns.hasOwnProperty(a)};
f.isConst=function(a){return this.consts.hasOwnProperty(a)};f.isAddOp=function(a){return this.addOps.hasOwnProperty(a)};f.isMulOp=function(a){return this.mulOps.hasOwnProperty(a)};f.getFnVal=function(a){return this.isMulOp(a)?this.mulOps[a]:this.isAddOp(a)?this.addOps[a]:"_pow"==a?this._pow:"_negate"==a?this._negate:this.fns[a]};f.isValidId=function(a){return"string"==typeof a&&/^[A-Za-z_][A-Za-z_0-9]*$/.test(a)};f.isKnownId=function(a){return this.isFnName(a)||this.isConst(a)||this.isAddOp(a)||this.isMulOp(a)||
this.isVarName(a)||a==this._powOpId};h=z;var s=function(a,b,c){a=Error(a);a.name="ParseError";a.range={start:b,end:c};return a},k=function(a,b,c){if(!(this instanceof k))return new k(a,b,c);this.type=a;this.val=b;this.rangeInInput=c};k.prototype.toString=function(){return this.type+(this.val?"("+this.val.toString()+")":"")};var d={Num:"num",Const:"const",Var:"var",Negate:"negate",Pow:"pow",MulOp:"mulop",AddOp:"addop",Fn:"fn",LP:"lp",RP:"rp",Comma:"comma"},p=function(a,b){if(!(this instanceof p))return new p(a,
b);this.name=b;this.argCount=0;this.envVal=a.getFnVal(b)};p.prototype.toString=function(){return this.envVal.name?this.envVal.name:this.name};var A,X=function(a){if(0!==a.s.length){switch(a.s.charAt(0)){case "(":B(a);v(a,d.LP);a.consumeOneChar();return;case ")":v(a,d.RP);a.consumeOneChar();return;case ",":v(a,d.Comma);a.consumeOneChar();return;case "-":if("-"!=a.s.charAt(0))throw a.parseErrorAtCurrentS("Expected a minus sign.");var b;0===a.tokens.length?b=!0:(b=a.tokens[a.tokens.length-1],b=b.type==
d.LP||b.type==d.AddOp||b.type==d.MulOp||b.type==d.Comma||b.type==d.Pow||b.type==d.Negate);b?t(a,d.Negate,"_negate",1):t(a,d.AddOp,a.env._subtractOpId);a.consumeOneChar();return}if(Q.test(a.s))a:{var c=Q.exec(a.s);if(!c)throw a.parseErrorAtCurrentS("Expected a identifier.");b=c[1];var c=c[2],x=R(a,b);if(x)B(a),a.tokens.push(x),a.s=c;else{if(a.env.options.implicitMul&&1<b.length)for(;1<b.length;)if(c=b.charAt(b.length-1)+c,b=b.substr(0,b.length-1),x=R(a,b)){B(a);a.tokens.push(x);a.s=c;break a}throw a.parseErrorAtCurrentS('Unknown identifier "'+
b+'".',b.length);}}else if(V.test(a.s)){b=W.exec(a.s);if(!b)throw a.parseErrorAtCurrentS("Expected a number.");B(a,!1);v(a,d.Num,parseFloat(b[1]),b[1].length);a.s=b[2]}else try{b=a.s.charAt(0);c=a.env;if(c.isAddOp(b))t(a,d.AddOp,b);else if(c.isMulOp(b))t(a,d.MulOp,b);else if(c.options.powOp&&b==c._powOpId)t(a,d.Pow,"_pow",1);else throw a.parseErrorAtCurrentS("Expected an operator.");a.consumeOneChar()}catch(g){throw a.parseErrorAtCurrentS('Invalid character "'+a.s.charAt(0)+'".');}}},v=function(a,
b,c,d){c||(d=1);a.tokens.push(k(b,c,a.rangeFromCurrentS(d)))},t=function(a,b,c,d){d=void 0!==d?d:c.length;v(a,b,p(a.env,c),d)},B=function(a,b){if(a.env.options.implicitMul&&0!==a.tokens.length){var c=a.tokens[a.tokens.length-1].type;(c==d.RP||c==d.Var||c==d.Const||!1!==b&&c==d.Num)&&t(a,d.MulOp,a.env._implicitMulOpId,0)}},R=function(a,b){var c,e=a.env;e.isFnName(b)?c=k(d.Fn,p(a.env,b),a.rangeFromCurrentS(b.length)):e.isConst(b)?c=k(d.Const,e.consts[b],a.rangeFromCurrentS(b.length)):e.isVarName(b)&&
(c=k(d.Var,b,a.rangeFromCurrentS(b.length)));return c},Q=/^([A-Za-z_][A-Za-z_0-9]*)(.*)/,W=/^([0-9]*\.?[0-9]+)(.*)/,V=/^[0-9.]/,m=function(a,b){var c;if(!(this instanceof m))return new m(a,b);var d=[];c=/\s/;for(var g="",n=0;n<b.length;n++){var e=b.charAt(n);c.test(e)||(d.push(n),g+=e)}c=g;this.env=a;this.s=c;this._origLength=c.length;this._whitespaceMap=d;this.tokens=[]};m.prototype.consumeOneChar=function(){this.s=this.s.substring(1)};m.prototype.currentPositionInInput=function(){return this._origLength-
this.s.length};m.prototype.rangeFromCurrentS=function(a){var b=this.currentPositionInInput(),c=this._whitespaceMap[b];return{start:c,end:0===a?c:this._whitespaceMap[b+a-1]+1}};m.prototype.parseErrorAtCurrentS=function(a,b){void 0===b&&(b=1);var c=this.rangeFromCurrentS(b);return s(a,c.start,c.end)};A=function(a,b){for(var c=m(a,b);0<c.s.length;)X(c);return c.tokens};var l,S=function(a,b,c,d){var g=b;d||(c?(g+="\\-",b+="  "):(g+="|-",b+="| "));g+=a.root.toString()+"\n";if(a.children)for(c=0;c<a.children.length;c++)g+=
S(a.children[c],b,c==a.children.length-1);return g},u=function(a,b){if(!(this instanceof u))return new u(a,b);this.root=a;this.children=b};u.prototype.isLeaf=function(){return!this.children||0===this.children.length};u.prototype.isConstant=function(){var a;if(a=this.root.type!=d.Var)if(a=!(this.root.type==d.Fn&&this.root.val.envVal.nondeterministic))if(!(a=this.isLeaf()))a:{a=this.children;for(var b=0;b<a.length;b++)if(!a[b].isConstant()){a=!1;break a}a=!0}return a};u.prototype.toString=function(){return S(this,
"",!1,!0)};l=u;var D,w=function(a){return s("Unexpected end of expression: "+a)},I=function(a,b){for(var c=T(a,b);0<b.length&&b[0].type==d.AddOp;)c=l(b.shift(),[c,T(a,b)]);return c},T=function(a,b){for(var c=E(a,b);0<b.length&&b[0].type==d.MulOp;)c=l(b.shift(),[c,E(a,b)]);return c},E=function(a,b){var c;if(0===b.length)throw w("Expected a factor.");if(b[0].type==d.Negate)c=l(b.shift(),[E(a,b)]);else{a:{if(0===b.length)throw w("Expected a datum.");switch(b[0].type){case d.Var:case d.Num:case d.Const:c=
l(b.shift());break a;case d.Fn:c=F(b,d.Fn,"function name");var e=l(c,[]);F(b,d.LP,"left parenthesis","Functions must be followed by an opening parenthesis.");for(var g=c.val.envVal.length,n=c.val.envVal.lengthIsMinimum,C=!1;0<b.length&&b[0].type!=d.RP&&(n||c.val.argCount<g);)e.children.push(I(a,b)),c.val.argCount++,C=!1,c.val.argCount<g?(F(b,d.Comma,"comma",'Too few arguments to "'+c.val.name+'"? Expected '+(n?"at least ":"")+g+" but got "+c.val.argCount+"."),C=!0):n&&(0<b.length&&b[0].type==d.Comma)&&
(b.shift(),C=!0);if(n&&c.val.argCount<g||!n&&c.val.argCount!=g){c='Too few arguments to "'+c.val.name+'"? Expected '+((n?"at least ":"")+g)+" but got "+c.val.argCount;if(0===b.length)throw w(c);throw s(c,b[0].rangeInInput.start,b[0].rangeInInput.end);}if(C)throw w("Expected an expression after comma.");U(b,'Too many arguments to "'+c.val.name+'"? Expected '+g+".",a);c=e;break a;case d.LP:b.shift();c=I(a,b);U(b,"Mismatched parentheses.",a);break a;default:throw s("Expected a datum.",b[0].rangeInInput.start,
b[0].rangeInInput.end);}}0<b.length&&b[0].type==d.Pow&&(c=l(b.shift(),[c,E(a,b)]))}return c},F=function(a,b,c,d){if(0===a.length||a[0].type!=b){b="Expected "+(c||b)+".";d&&(b+=" "+d);if(0===a.length)throw w(b);throw s(b,a[0].rangeInInput.start,a[0].rangeInInput.end);}return a.shift()},U=function(a,b,c){return c.options.autoParens&&0===a.length?k(d.RP):F(a,d.RP,"right parenthesis",b)};D=function(a,b){var c=b.slice(),d=I(a,c);if(0<c.length)throw s("Unexpected token(s) after end of expression.",c[0].rangeInInput.start);
return d};var J=function(){function a(a,c,d){var d=G(d,{optimize:!0}),e={},i=!1,a="(function("+b(a)+") { return "+f(a,c,e,d.optimize)+"; })",h;for(h in e)e.hasOwnProperty(h)&&(i=!0,a="var "+h+" = "+e[h]+"; "+a);i&&(a="var env = arguments[0]; "+a);return eval(a)}function b(a){for(var b="",c=0;c<a.vars.length;c++)b+="__var_"+a.vars[c]+"__",c!=a.vars.length-1&&(b+=", ");return b}function c(a,b,c){var f;if(b.val instanceof p&&(b.val.envVal instanceof e||b.val.envVal instanceof i))return b.val.envVal.name;
switch(b.type){case d.Num:case d.Const:return b.val.toString();case d.Var:return"__var_"+b.val+"__";case d.Negate:case d.Pow:return a="__env_"+b.val.name+"__",c&&(c[a]='env["'+b.val.name+'"]'),a;case d.MulOp:f="mulOps";break;case d.AddOp:f="addOps";break;case d.Fn:f="fns"}a="__env_"+b.val.name+"__";c&&(c[a]="env."+f+'["'+b.val.name+'"]');return a}function f(b,e,h,k){var l=e.root.val instanceof p&&!(e.root.val.envVal instanceof i),m=e.root.val instanceof p&&e.root.val.envVal instanceof i,j,q;if(e.root.type==
d.Num||e.root.type==d.Const)return c(b,e.root);if(!1!==k&&e.isConstant())return a(b,e,{optimize:!1})().toString();j=c(b,e.root,h);l?j+="(":m&&(q=j,j="(");if(m)if(1==e.children.length)j+=q+f(b,e.children[0],h,k);else if(2==e.children.length)j+=f(b,e.children[0],h,k)+" "+q+" "+f(b,e.children[1],h,k);else throw Error("Invalid parse tree; a native operator was specified with "+e.children.length+" arguments.");else if(e.children)for(q=0;q<e.children.length;q++)j+=f(b,e.children[q],h,k),l&&q!=e.children.length-
1&&(j+=", ");if(l||m)j+=")";return j}return a}(),f=function(){var a,b;switch(arguments.length){case 0:throw Error("Invalid arguments");case 1:if("string"!=typeof arguments[0])throw Error("Invalid arguments");a=h();b=arguments[0];break;case 2:if("string"!=typeof arguments[1])throw Error("Invalid arguments");b=arguments[1];if(arguments[0]instanceof h)a=arguments[0];else if("string"==typeof arguments[0])a=h(arguments[0].split(","));else if("[object Array]"===Object.prototype.toString.call(arguments[0]))a=
h(arguments[0]);else throw Error("Invalid arguments");break;default:a=[];for(b=0;b<arguments.length-1;b++){if("string"!=typeof arguments[b])throw Error("Invalid arguments");a.push.apply(a,arguments[b].split(","))}if("string"!=typeof arguments[arguments.length-1])throw Error("Invalid arguments");a=h(a);b=arguments[arguments.length-1]}return J(a,D(a,A(a,b)))},K={oneshot:function(a,b){var c,d=[];if(1==arguments.length){if("string"!=typeof a)throw Error("Invalid arguments");c=h();b=a}else{c=[];for(var e in a)a.hasOwnProperty(e)&&
(c.push(e),d.push(a[e]));c=h(c)}return J(c,D(c,A(c,b))).apply(null,d)},Environment:h,NativeOp:i,NativeFn:e,compile:J,lex:A,parse:D,ParseTree:l,Token:k,TokenType:d,FnCall:p},r;for(r in K)K.hasOwnProperty(r)&&(f[r]=K[r]);r={Expr:f};"undefined"!=typeof module&&module.exports&&(module.exports=r);return r}();
