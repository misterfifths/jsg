'use strict';var JSG=function(){var m=function(a,b){if(!(this instanceof m))return new m(a,b);this.name=a;this.length=b;this.nondeterministic=this.lengthIsMinimum=!1},e=function(a,b,c,i){if(!(this instanceof e))return new e(a,b,c,i);this.name=a;this.length=b;this.lengthIsMinimum=!!c;this.nondeterministic=!!i},j,p=function(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},w=function(a,b){if(!a.isValidId(b))throw Error("Invalid ID: "+b);if(a.isKnownId(b))throw Error("ID "+b+" is already in use");
},z=function(a,b,c){if("string"!=typeof b||1!=b.length||" "==b)throw Error("Operators IDs be a single, non-space character");if(a.isKnownId(b))throw Error("Operator ID "+b+" is already in use");if(2!=c.length)throw Error("Operators must take exactly 2 arguments");},q=function(a,b,c,i){if(!(this instanceof q))return new q(a,b,c,i);this.fns=p(A);this.consts=p(B);this.addOps=p(C);this.mulOps=p(D);this.noAutoParens=!!b;this.noImplicitMul=!!c;this.noPowOp=!!i;this.vars=a?a.slice():[];this._implicitMulOpId=
"*";this._subtractOpId="-";this._negate=m("-",1);this._pow=e("Math.pow",2);this._powOpId="^"},A,B,C,D;A={sin:e("Math.sin",1),cos:e("Math.cos",1),tan:e("Math.tan",1),asin:e("Math.asin",1),arcsin:e("Math.asin",1),acos:e("Math.acos",1),arccos:e("Math.acos",1),atan:e("Math.atan",1),arctan:e("Math.atan",1),atan2:e("Math.atan2",2),arctan2:e("Math.atan2",2),exp:e("Math.exp",1),sqrt:e("Math.sqrt",1),pow:e("Math.pow",2),log:e("Math.log",1),ln:e("Math.log",1),log10:function(a){return Math.log(a)/Math.LN10},
log2:function(a){return Math.log(a)/Math.LN2},logn:function(a,b){return Math.log(b)/Math.log(a)},max:e("Math.max",2,!0),min:e("Math.min",2,!0),abs:e("Math.abs",1),floor:e("Math.floor",1),ceil:e("Math.ceil",1),ceiling:e("Math.ceil",1),round:e("Math.round",1),random:e("Math.random",0,!1,!0),rnd:e("Math.random",0,!1,!0),rand:e("Math.random",0,!1,!0),mod:m("%",2)};B={e:Math.E,ln10:Math.LN10,log10:Math.LN10,ln2:Math.LN2,log2:Math.LN2,log10e:Math.LOG10E,log2e:Math.LOG2E,pi:Math.PI,sqrt1_2:Math.SQRT1_2,
sqrt2:Math.SQRT2};C={"+":m("+",2),"-":m("-",2)};D={"*":m("*",2),"/":m("/",2),"%":m("%",2)};var g=q.prototype;g.setVars=function(a){for(var b=0;b<a.length;b++)w(this,name);this.vars=a.slice(0)};g.addFn=function(a,b){w(this,a);this.fns[a]=b};g.removeFn=function(a){delete this.fns[a]};g.addConst=function(a,b){w(this,a);this.consts[a]=b};g.removeConst=function(a){delete this.consts[a]};g.addAddOp=function(a,b){z(this,a,b);this.addOps[a]=b};g.removeAddOp=function(a){delete this.addOps[a]};g.addMulOp=function(a,
b){z(this,a,b);this.mulOps[a]=b};g.removeMulOp=function(a){delete this.mulOps[a]};g.isVarName=function(a){for(var b=0;b<this.vars.length;b++)if(this.vars[b]==a)return!0};g.isFnName=function(a){return this.fns.hasOwnProperty(a)};g.isConst=function(a){return this.consts.hasOwnProperty(a)};g.isAddOp=function(a){return this.addOps.hasOwnProperty(a)};g.isMulOp=function(a){return this.mulOps.hasOwnProperty(a)};g.getFnVal=function(a){return this.isMulOp(a)?this.mulOps[a]:this.isAddOp(a)?this.addOps[a]:"_pow"==
a?this._pow:"_negate"==a?this._negate:this.fns[a]};g.isValidId=function(a){return"string"==typeof a&&/^[A-Za-z_][A-Za-z_0-9]*$/.test(a)};g.isKnownId=function(a){return this.isFnName(a)||this.isConst(a)||this.isAddOp(a)||this.isMulOp(a)||this.isVarName(a)||a==this._powOpId};j=q;var k=function(a,b){if(!(this instanceof k))return new k(a,b);this.type=a;this.val=b},d={Num:"num",Const:"const",Var:"var",Negate:"negate",Pow:"pow",MulOp:"mulop",AddOp:"addop",Fn:"fn",LP:"lp",RP:"rp",Comma:"comma"},n=function(a,
b){if(!(this instanceof n))return new n(a,b);this.name=b;this.argCount=0;this.envVal=a.getFnVal(b)},r,K=function(a){if(0!==a.s.length){switch(a.s.charAt(0)){case "(":s(a);a.tokens.push(k(d.LP,void 0));a.s=a.s.substring(1);return;case ")":a.tokens.push(k(d.RP,void 0));a.s=a.s.substring(1);return;case ",":a.tokens.push(k(d.Comma,void 0));a.s=a.s.substring(1);return;case "-":if("-"!=a.s.charAt(0))throw Error("Expected a minus");var b;0===a.tokens.length?b=!0:(b=a.tokens[a.tokens.length-1],b=b.type==
d.LP||b.type==d.AddOp||b.type==d.MulOp||b.type==d.Comma||b.type==d.Pow||b.type==d.Negate);b?o(a,d.Negate,"_negate"):o(a,d.AddOp,a.env._subtractOpId);a.s=a.s.substring(1);return}if(E.test(a.s))a:{var c=E.exec(a.s);if(!c)throw Error("Expected an identifier");b=c[1];var c=c[2],i=F(a,b);if(i)s(a),a.tokens.push(i),a.s=c;else{if(!a.env.noImplicitMul&&1<b.length)for(;1<b.length;)if(c=b.charAt(b.length-1)+c,b=b.substr(0,b.length-1),i=F(a,b)){s(a);a.tokens.push(i);a.s=c;break a}throw Error("Unknown identifier "+
b);}}else if(I.test(a.s)){b=J.exec(a.s);if(!b)throw Error("Expected a number");s(a,!1);c=parseFloat(b[1]);a.tokens.push(k(d.Num,c));a.s=b[2]}else try{b=a.s.charAt(0);c=a.env;if(c.isAddOp(b))o(a,d.AddOp,b);else if(c.isMulOp(b))o(a,d.MulOp,b);else if(!c.noPowOp&&b==c._powOpId)o(a,d.Pow,"_pow");else throw Error("Expected an operator");a.s=a.s.substring(1)}catch(f){throw Error("Invalid input: "+a.s);}}},o=function(a,b,c){c=n(a.env,c);a.tokens.push(k(b,c))},s=function(a,b){if(!(a.env.noImplicitMul||0===
a.tokens.length)){var c=a.tokens[a.tokens.length-1].type;(c==d.RP||c==d.Var||c==d.Const||!1!==b&&c==d.Num)&&o(a,d.MulOp,a.env._implicitMulOpId)}},F=function(a,b){var c,i=a.env;i.isFnName(b)?c=k(d.Fn,n(a.env,b)):i.isConst(b)?c=k(d.Const,i.consts[b]):i.isVarName(b)&&(c=k(d.Var,b));return c},E=/^([A-Za-z_][A-Za-z_0-9]*)(.*)/,J=/^([0-9]*\.?[0-9]+)(.*)/,I=/^[0-9.]/;r=function(a,b){for(var c=b.replace(/\s/g,""),i=[],c={env:a,s:c,tokens:i};0<c.s.length;)K(c);return i};var t,x=function(a,b){for(var c=G(a,
b);0<b.length&&b[0].type==d.AddOp;)c=l(b.shift(),[c,G(a,b)]);return c},G=function(a,b){for(var c=u(a,b);0<b.length&&b[0].type==d.MulOp;)c=l(b.shift(),[c,u(a,b)]);return c},u=function(a,b){var c;if(0===b.length)throw Error("Expected a factor");if(b[0].type==d.Negate)c=l(b.shift(),[u(a,b)]);else{a:{if(0===b.length)throw Error("Expected a datum");switch(b[0].type){case d.Var:case d.Num:case d.Const:c=l(b.shift());break a;case d.Fn:c=v(b,d.Fn,"function name");var i=l(c,[]);v(b,d.LP,"left parenthesis",
"Functions must be followed by an opening parenthesis");for(var f=c.val.envVal.length,e=c.val.envVal.lengthIsMinimum,h=!1;0<b.length&&b[0].type!=d.RP&&(e||c.val.argCount<f);)i.children.push(x(a,b)),c.val.argCount++,h=!1,c.val.argCount<f?(v(b,d.Comma,"comma","Too few arguments to "+c.val.name+"? Expecting "+(e?" at least ":"")+f+" but got "+c.val.argCount),h=!0):e&&(0<b.length&&b[0].type==d.Comma)&&(b.shift(),h=!0);if(h)throw Error("Expected an expression after comma");if(e&&c.val.argCount<f)throw Error("Invalid number of arguments to "+
c.val.name+": expected at least "+f+" but got "+c.val.argCount);if(!e&&c.val.argCount!=f)throw Error("Invalid number of arguments to "+c.val.name+": expected "+f+" but got "+c.val.argCount);H(b,"Too many arguments to "+c.val.name+"? Expected "+f,a);c=i;break a;case d.LP:b.shift();c=x(a,b);H(b,"Mismatched parentheses",a);break a;default:throw Error("Expected a datum");}}0<b.length&&b[0].type==d.Pow&&(c=l(b.shift(),[c,u(a,b)]))}return c},v=function(a,b,c,i){if(0===a.length||a[0].type!=b)throw a="Expected "+
(c||b),i&&(a+=" - "+i),Error(a);return a.shift()},H=function(a,b,c){return!c.noAutoParens&&0===a.length?k(d.RP):v(a,d.RP,"right parenthesis",b)},l=function(a,b){if(!(this instanceof l))return new l(a,b);this.root=a;this.children=b};l.prototype.isLeaf=function(){return!this.children||0===this.children.length};l.prototype.isConstant=function(){var a;if(a=this.root.type!=d.Var)if(a=!(this.root.type==d.Fn&&this.root.val.envVal.nondeterministic))if(!(a=this.isLeaf()))a:{a=this.children;for(var b=0;b<a.length;b++)if(!a[b].isConstant()){a=
!1;break a}a=!0}return a};t=function(a,b){var c=b.slice(),i=x(a,c);if(0<c.length)throw Error("Unexpected token(s) after end of expression");return i};var y=function(){function a(a,b,d){var d=!!d,e={},a="(function("+a.vars.join(",")+") { return "+c(a,b,e,!d)+"; })",b=!1,g;for(g in e)e.hasOwnProperty(g)&&(b=!0,a="var "+g+" = "+e[g]+"; "+a);b&&(a="var env = arguments[0]; "+a);return eval(a)}function b(a,b,c){var h;if(b.val instanceof n&&(b.val.envVal instanceof e||b.val.envVal instanceof m))return b.val.envVal.name;
switch(b.type){case d.Num:case d.Const:return b.val.toString();case d.Var:return b.val;case d.Negate:case d.Pow:return a="__env_"+b.val.name+"__",c&&(c[a]='env["'+b.val.name+'"]'),a;case d.MulOp:h="mulOps";break;case d.AddOp:h="addOps";break;case d.Fn:h="fns"}a="__env_"+b.val.name+"__";c&&(c[a]="env."+h+'["'+b.val.name+'"]');return a}function c(e,f,g,h){var k=f.root.val instanceof n&&!(f.root.val.envVal instanceof m),l=f.root.val instanceof n&&f.root.val.envVal instanceof m,j;if(f.root.type==d.Num||
f.root.type==d.Const)return b(e,f.root);if(!1!==h&&f.isConstant())return a(e,f,!0)().toString();h=b(e,f.root,g);k?h+="(":l&&(j=h,h="(");if(l)if(1==f.children.length)h+=j+c(e,f.children[0],g);else if(2==f.children.length)h+=c(e,f.children[0],g)+" "+j+" "+c(e,f.children[1],g);else throw Error("Invalid parse tree; a native operator was specified with "+f.children.length+" arguments");else if(f.children)for(j=0;j<f.children.length;j++)h+=c(e,f.children[j],g),k&&j!=f.children.length-1&&(h+=", ");if(k||
l)h+=")";return h}return a}();return{Expr:{compile:function(){var a,b;switch(arguments.length){case 0:throw Error("Invalid arguments");case 1:if("string"!=typeof arguments[0])throw Error("Invalid arguments");a=j();b=arguments[0];break;case 2:if("string"!=typeof arguments[1])throw Error("Invalid arguments");b=arguments[1];if(arguments[0]instanceof j)a=arguments[0];else if("string"==typeof arguments[0])a=j(arguments[0].split(","));else if("[object Array]"===Object.prototype.toString.call(arguments[0]))a=
j(arguments[0]);else throw Error("Invalid arguments");break;default:a=[];for(b=0;b<arguments.length-1;b++){if("string"!=typeof arguments[b])throw Error("Invalid arguments");a.push.apply(a,arguments[b].split(","))}if("string"!=typeof arguments[arguments.length-1])throw Error("Invalid arguments");a=j(a);b=arguments[arguments.length-1]}return y(a,t(a,r(a,b)))},oneshot:function(a,b){var c,d=[];if(1==arguments.length){if("string"!=typeof a)throw Error("Invalid arguments");c=j();b=a}else{c=[];for(var e in a)a.hasOwnProperty(e)&&
(c.push(e),d.push(a[e]));c=j(c)}return y(c,t(c,r(c,b))).apply(null,d)},Environment:j,NativeOp:m,NativeFn:e,Core:{compile:y,lex:r,parse:t,Token:k,TokenType:d,FnCall:n}}}}();
