'use strict';var JSG=function(){function z(a,b){var c={},f;for(f in b)b.hasOwnProperty(f)&&(c[f]=a&&a.hasOwnProperty(f)?a[f]:b[f]);return c}var i=function(a,b){this.name=a;this.length=b;this.nondeterministic=this.lengthIsMinimum=!1},d=function(a,b,c){c=z(c,{lengthIsMinimum:!1,nondeterministic:!1});this.name=a;this.length=b;this.lengthIsMinimum=c.lengthIsMinimum;this.nondeterministic=c.nondeterministic};i.prototype.toString=d.prototype.toString=function(){return this.name};var A=function(a){var b=
{},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},F=function(a,b){if(!a.isValidId(b))throw Error("Invalid ID: "+b);if(a.isKnownId(b))throw Error("ID "+b+" is already in use");},I=function(a,b,c){if("string"!=typeof b||1!=b.length||" "==b)throw Error("Operators IDs be a single, non-space character");if(a.isKnownId(b))throw Error("Operator ID "+b+" is already in use");if(2!=c.length)throw Error("Operators must take exactly 2 arguments");},l=function(a,b){this.options=z(b,{autoParens:!0,implicitMul:!0,
powOp:!0});this.fns=A(J);this.consts=A(K);this.addOps=A(L);this.mulOps=A(M);this._implicitMulOpId="*";this._subtractOpId="-";this._negate=new i("-",1);this._pow=new d("Math.pow",2);this._powOpId="^";this.vars=[];a&&this.setVars(a)},J,K,L,M;J={sin:new d("Math.sin",1),cos:new d("Math.cos",1),tan:new d("Math.tan",1),asin:new d("Math.asin",1),arcsin:new d("Math.asin",1),acos:new d("Math.acos",1),arccos:new d("Math.acos",1),atan:new d("Math.atan",1),arctan:new d("Math.atan",1),atan2:new d("Math.atan2",
2),arctan2:new d("Math.atan2",2),exp:new d("Math.exp",1),sqrt:new d("Math.sqrt",1),pow:new d("Math.pow",2),log:new d("Math.log",1),ln:new d("Math.log",1),log10:function(a){return Math.log(a)/Math.LN10},log2:function(a){return Math.log(a)/Math.LN2},logn:function(a,b){return Math.log(b)/Math.log(a)},max:new d("Math.max",2,{lengthIsMinimum:!0}),min:new d("Math.min",2,{lengthIsMinimum:!0}),abs:new d("Math.abs",1),floor:new d("Math.floor",1),ceil:new d("Math.ceil",1),ceiling:new d("Math.ceil",1),round:new d("Math.round",
1),random:new d("Math.random",0,{nondeterministic:!0}),rnd:new d("Math.random",0,{nondeterministic:!0}),rand:new d("Math.random",0,{nondeterministic:!0}),mod:new i("%",2)};K={e:Math.E,ln10:Math.LN10,log10:Math.LN10,ln2:Math.LN2,log2:Math.LN2,log10e:Math.LOG10E,log2e:Math.LOG2E,pi:Math.PI,sqrt1_2:Math.SQRT1_2,sqrt2:Math.SQRT2};L={"+":new i("+",2),"-":new i("-",2)};M={"*":new i("*",2),"/":new i("/",2),"%":new i("%",2)};var g=l.prototype;g.setVars=function(a){for(var b=0;b<a.length;b++)F(this,a[b]);
this.vars=a.slice()};g.addFn=function(a,b){F(this,a);this.fns[a]=b};g.removeFn=function(a){delete this.fns[a]};g.addConst=function(a,b){F(this,a);this.consts[a]=b};g.removeConst=function(a){delete this.consts[a]};g.addAddOp=function(a,b){I(this,a,b);this.addOps[a]=b};g.removeAddOp=function(a){delete this.addOps[a]};g.addMulOp=function(a,b){I(this,a,b);this.mulOps[a]=b};g.removeMulOp=function(a){delete this.mulOps[a]};g.isVarName=function(a){for(var b=0;b<this.vars.length;b++)if(this.vars[b]==a)return!0};
g.isFnName=function(a){return this.fns.hasOwnProperty(a)};g.isConst=function(a){return this.consts.hasOwnProperty(a)};g.isAddOp=function(a){return this.addOps.hasOwnProperty(a)};g.isMulOp=function(a){return this.mulOps.hasOwnProperty(a)};g.getFnVal=function(a){return this.isMulOp(a)?this.mulOps[a]:this.isAddOp(a)?this.addOps[a]:"_pow"==a?this._pow:"_negate"==a?this._negate:this.fns[a]};g.isValidId=function(a){return"string"==typeof a&&/^[A-Za-z_][A-Za-z_0-9]*$/.test(a)};g.isKnownId=function(a){return this.isFnName(a)||
this.isConst(a)||this.isAddOp(a)||this.isMulOp(a)||this.isVarName(a)||a==this._powOpId};var s=function(a,b,c){a=Error(a);a.name="ParseError";a.range={start:b,end:c};return a},m=function(a,b,c){this.type=a;this.val=b;this.rangeInInput=c};m.prototype.toString=function(){return this.type+(this.val?"("+this.val.toString()+")":"")};var e={Num:"num",Const:"const",Var:"var",Negate:"negate",Pow:"pow",MulOp:"mulop",AddOp:"addop",Fn:"fn",LP:"lp",RP:"rp",Comma:"comma"},q=function(a,b){this.name=b;this.argCount=
0;this.envVal=a.getFnVal(b)};q.prototype.toString=function(){return this.envVal.name?this.envVal.name:this.name};var u,U=function(a){if(0!==a.s.length){switch(a.s.charAt(0)){case "(":B(a);v(a,e.LP);a.consumeOneChar();return;case ")":v(a,e.RP);a.consumeOneChar();return;case ",":v(a,e.Comma);a.consumeOneChar();return;case "-":if("-"!=a.s.charAt(0))throw a.parseErrorAtCurrentS("Expected a minus sign.");var b;0===a.tokens.length?b=!0:(b=a.tokens[a.tokens.length-1],b=b.type==e.LP||b.type==e.AddOp||b.type==
e.MulOp||b.type==e.Comma||b.type==e.Pow||b.type==e.Negate);b?t(a,e.Negate,"_negate",1):t(a,e.AddOp,a.env._subtractOpId);a.consumeOneChar();return}if(N.test(a.s))a:{var c=N.exec(a.s);if(!c)throw a.parseErrorAtCurrentS("Expected a identifier.");b=c[1];var c=c[2],f=O(a,b);if(f)B(a),a.tokens.push(f),a.s=c;else{if(a.env.options.implicitMul&&1<b.length)for(;1<b.length;)if(c=b.charAt(b.length-1)+c,b=b.substr(0,b.length-1),f=O(a,b)){B(a);a.tokens.push(f);a.s=c;break a}throw a.parseErrorAtCurrentS('Unknown identifier "'+
b+'".',b.length);}}else if(S.test(a.s)){b=T.exec(a.s);if(!b)throw a.parseErrorAtCurrentS("Expected a number.");B(a,!1);v(a,e.Num,parseFloat(b[1]),b[1].length);a.s=b[2]}else try{b=a.s.charAt(0);c=a.env;if(c.isAddOp(b))t(a,e.AddOp,b);else if(c.isMulOp(b))t(a,e.MulOp,b);else if(c.options.powOp&&b==c._powOpId)t(a,e.Pow,"_pow",1);else throw a.parseErrorAtCurrentS("Expected an operator.");a.consumeOneChar()}catch(h){throw a.parseErrorAtCurrentS('Invalid character "'+a.s.charAt(0)+'".');}}},v=function(a,
b,c,f){c||(f=1);a.tokens.push(new m(b,c,a.rangeFromCurrentS(f)))},t=function(a,b,c,f){f=void 0!==f?f:c.length;v(a,b,new q(a.env,c),f)},B=function(a,b){if(a.env.options.implicitMul&&0!==a.tokens.length){var c=a.tokens[a.tokens.length-1].type;(c==e.RP||c==e.Var||c==e.Const||!1!==b&&c==e.Num)&&t(a,e.MulOp,a.env._implicitMulOpId,0)}},O=function(a,b){var c,f=a.env;f.isFnName(b)?c=new m(e.Fn,new q(a.env,b),a.rangeFromCurrentS(b.length)):f.isConst(b)?c=new m(e.Const,f.consts[b],a.rangeFromCurrentS(b.length)):
f.isVarName(b)&&(c=new m(e.Var,b,a.rangeFromCurrentS(b.length)));return c},N=/^([A-Za-z_][A-Za-z_0-9]*)(.*)/,T=/^([0-9]*\.?[0-9]+)(.*)/,S=/^[0-9.]/,w=function(a,b){var c,f=[];c=/\s/;for(var h="",n=0;n<b.length;n++){var e=b.charAt(n);c.test(e)||(f.push(n),h+=e)}c=h;this.env=a;this.s=c;this._origLength=c.length;this._whitespaceMap=f;this.tokens=[]};w.prototype.consumeOneChar=function(){this.s=this.s.substring(1)};w.prototype.currentPositionInInput=function(){return this._origLength-this.s.length};w.prototype.rangeFromCurrentS=
function(a){var b=this.currentPositionInInput(),c=this._whitespaceMap[b];return{start:c,end:0===a?c:this._whitespaceMap[b+a-1]+1}};w.prototype.parseErrorAtCurrentS=function(a,b){void 0===b&&(b=1);var c=this.rangeFromCurrentS(b);return s(a,c.start,c.end)};u=function(a,b){for(var c=new w(a,b);0<c.s.length;)U(c);return c.tokens};var P=function(a,b,c,f){var h=b;f||(c?(h+="\\-",b+="  "):(h+="|-",b+="| "));h+=a.root.toString()+"\n";if(a.children)for(c=0;c<a.children.length;c++)h+=P(a.children[c],b,c==a.children.length-
1);return h},j=function(a,b){this.root=a;this.children=b};j.prototype.isLeaf=function(){return!this.children||0===this.children.length};j.prototype.isConstant=function(){var a;if(a=this.root.type!=e.Var)if(a=!(this.root.type==e.Fn&&this.root.val.envVal.nondeterministic))if(!(a=this.isLeaf()))a:{a=this.children;for(var b=0;b<a.length;b++)if(!a[b].isConstant()){a=!1;break a}a=!0}return a};j.prototype.toString=function(){return P(this,"",!1,!0)};var x,y=function(a){return s("Unexpected end of expression: "+
a)},G=function(a,b){for(var c=Q(a,b);0<b.length&&b[0].type==e.AddOp;)c=new j(b.shift(),[c,Q(a,b)]);return c},Q=function(a,b){for(var c=C(a,b);0<b.length&&b[0].type==e.MulOp;)c=new j(b.shift(),[c,C(a,b)]);return c},C=function(a,b){var c;if(0===b.length)throw y("Expected a factor.");if(b[0].type==e.Negate)c=new j(b.shift(),[C(a,b)]);else{a:{if(0===b.length)throw y("Expected a datum.");switch(b[0].type){case e.Var:case e.Num:case e.Const:c=new j(b.shift());break a;case e.Fn:c=D(b,e.Fn,"function name");
var f=new j(c,[]);D(b,e.LP,"left parenthesis","Functions must be followed by an opening parenthesis.");for(var h=c.val.envVal.length,n=c.val.envVal.lengthIsMinimum,d=!1;0<b.length&&b[0].type!=e.RP&&(n||c.val.argCount<h);)f.children.push(G(a,b)),c.val.argCount++,d=!1,c.val.argCount<h?(D(b,e.Comma,"comma",'Too few arguments to "'+c.val.name+'"? Expected '+(n?"at least ":"")+h+" but got "+c.val.argCount+"."),d=!0):n&&(0<b.length&&b[0].type==e.Comma)&&(b.shift(),d=!0);if(n&&c.val.argCount<h||!n&&c.val.argCount!=
h){c='Too few arguments to "'+c.val.name+'"? Expected '+((n?"at least ":"")+h)+" but got "+c.val.argCount;if(0===b.length)throw y(c);throw s(c,b[0].rangeInInput.start,b[0].rangeInInput.end);}if(d)throw y("Expected an expression after comma.");R(b,'Too many arguments to "'+c.val.name+'"? Expected '+h+".",a);c=f;break a;case e.LP:b.shift();c=G(a,b);R(b,"Mismatched parentheses.",a);break a;default:throw s("Expected a datum.",b[0].rangeInInput.start,b[0].rangeInInput.end);}}0<b.length&&b[0].type==e.Pow&&
(c=new j(b.shift(),[c,C(a,b)]))}return c},D=function(a,b,c,f){if(0===a.length||a[0].type!=b){b="Expected "+(c||b)+".";f&&(b+=" "+f);if(0===a.length)throw y(b);throw s(b,a[0].rangeInInput.start,a[0].rangeInInput.end);}return a.shift()},R=function(a,b,c){return c.options.autoParens&&0===a.length?new m(e.RP):D(a,e.RP,"right parenthesis",b)};x=function(a,b){var c=b.slice(),f=G(a,c);if(0<c.length)throw s("Unexpected token(s) after end of expression.",c[0].rangeInInput.start);return f};var E=function(){function a(a,
c,e){var e=z(e,{optimize:!0}),d={},g=!1,a="(function("+b(a)+") { return "+f(a,c,d,e.optimize)+"; })",i;for(i in d)d.hasOwnProperty(i)&&(g=!0,a="var "+i+" = "+d[i]+"; "+a);g&&(a="var env = arguments[0]; "+a);return eval(a)}function b(a){for(var b="",c=0;c<a.vars.length;c++)b+="__var_"+a.vars[c]+"__",c!=a.vars.length-1&&(b+=", ");return b}function c(a,b,c){var f;if(b.val instanceof q&&(b.val.envVal instanceof d||b.val.envVal instanceof i))return b.val.envVal.name;switch(b.type){case e.Num:case e.Const:return b.val.toString();
case e.Var:return"__var_"+b.val+"__";case e.Negate:case e.Pow:return a="__env_"+b.val.name+"__",c&&(c[a]='env["'+b.val.name+'"]'),a;case e.MulOp:f="mulOps";break;case e.AddOp:f="addOps";break;case e.Fn:f="fns"}a="__env_"+b.val.name+"__";c&&(c[a]="env."+f+'["'+b.val.name+'"]');return a}function f(b,d,g,j){var l=d.root.val instanceof q&&!(d.root.val.envVal instanceof i),m=d.root.val instanceof q&&d.root.val.envVal instanceof i,k,p;if(d.root.type==e.Num||d.root.type==e.Const)return c(b,d.root);if(!1!==
j&&d.isConstant())return a(b,d,{optimize:!1})().toString();k=c(b,d.root,g);l?k+="(":m&&(p=k,k="(");if(m)if(1==d.children.length)k+=p+f(b,d.children[0],g,j);else if(2==d.children.length)k+=f(b,d.children[0],g,j)+" "+p+" "+f(b,d.children[1],g,j);else throw Error("Invalid parse tree; a native operator was specified with "+d.children.length+" arguments.");else if(d.children)for(p=0;p<d.children.length;p++)k+=f(b,d.children[p],g,j),l&&p!=d.children.length-1&&(k+=", ");if(l||m)k+=")";return k}return a}(),
g=function(){var a,b,c,f;if(0===arguments.length)throw Error("Invalid arguments");a=Array.prototype.slice.apply(arguments);if("object"==typeof a[a.length-1]&&(c=a.pop(),0===a.length))throw Error("Invalid arguments");f=z(c,{debug:!1}).debug;if("string"!=typeof a[a.length-1])throw Error("Invalid arguments");b=a.pop();if(0===a.length)a=new l([],c);else if(1==a.length)if(arguments[0]instanceof l)a=arguments[0];else if("string"==typeof arguments[0])a=new l(arguments[0],c);else if("[object Array]"===Object.prototype.toString.call(arguments[0]))a=
new l(arguments[0],c);else throw Error("Invalid arguments");else throw Error("Invalid arguments");if(f){f={env:a};try{f.tokens=u(a,b);try{f.parseTree=x(a,f.tokens);try{f.fn=E(a,f.parseTree,c)}catch(d){d.when="compile",f.error=d}}catch(e){e.when="parse",f.error=e}}catch(g){g.when="lex",f.error=g}return f}b=u(a,b);b=x(a,b);return E(a,b,c)},H={oneshot:function(a,b,c){var d=[];if("string"==typeof a)c=b,b=a,a=new l(c);else{var e=[],g;for(g in a)a.hasOwnProperty(g)&&(e.push(g),d.push(a[g]));a=new l(e,c)}b=
u(a,b);b=x(a,b);return E(a,b,c).apply(null,d)},Environment:l,NativeOp:i,NativeFn:d,compile:E,lex:u,parse:x,ParseTree:j,Token:m,TokenType:e,FnCall:q},r;for(r in H)H.hasOwnProperty(r)&&(g[r]=H[r]);r={Expr:g};"undefined"!=typeof module&&module.exports&&(module.exports=r);return r}();
