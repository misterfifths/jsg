'use strict';var JSG=function(){var h=function(a,b){if(!(this instanceof h))return new h(a);this.name=a;this.length=b},d=function(a,b,c){if(!(this instanceof d))return new d(a,b,c);this.name=a;this.length=b;this.lengthIsMinimum=!!c},k,p=function(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},x=function(a,b){if(!a.isValidId(b))throw Error("Invalid ID: "+b);if(a.isKnownId(b))throw Error("ID "+b+" is already in use");},y=function(a,b,c){if("string"!=typeof b||1!=b.length||" "==b)throw Error("Operators IDs be a single, non-space character");
if(a.isKnownId(b))throw Error("Operator ID "+b+" is already in use");if(!a.noArityCheck&&2!=c.length)throw Error("Operators must take exactly 2 arguments");},q=function(a,b,c,e){if(!(this instanceof q))return new q(a,b,c,e);this.fns=p(z);this.consts=p(A);this.addops=p(B);this.mulops=p(C);this.noImplicitMul=!!b;this.noPowOp=!!c;this.noArityCheck=!!e;this.vars=a?a.slice():[];this._implicitMulOpId="*";this._subtractOpId="-";this._negate=h("-",1);this._pow=d("Math.pow",2);this._powOpId="^"},z,A,B,C;z=
{sin:d("Math.sin",1),cos:d("Math.cos",1),tan:d("Math.tan",1),asin:d("Math.asin",1),arcsin:d("Math.asin",1),acos:d("Math.acos",1),arccos:d("Math.acos",1),atan:d("Math.atan",1),arctan:d("Math.atan",1),atan2:d("Math.atan2",2),arctan2:d("Math.atan2",2),exp:d("Math.exp",1),sqrt:d("Math.sqrt",1),pow:d("Math.pow",2),log:d("Math.log",1),ln:d("Math.log",1),log10:function(a){return Math.log(a)/Math.LN10},log2:function(a){return Math.log(a)/Math.LN2},logn:function(a,b){return Math.log(b)/Math.log(a)},max:d("Math.max",
2,!0),min:d("Math.min",2,!0),abs:d("Math.abs",1),floor:d("Math.floor",1),ceil:d("Math.ceil",1),ceiling:d("Math.ceil",1),round:d("Math.round",1),random:d("Math.random",0),rnd:d("Math.random",0),rand:d("Math.random",0),mod:h("%",2)};A={e:Math.E,ln10:Math.LN10,log10:Math.LN10,ln2:Math.LN2,log2:Math.LN2,log10e:Math.LOG10E,log2e:Math.LOG2E,pi:Math.PI,sqrt1_2:Math.SQRT1_2,sqrt2:Math.SQRT2};B={"+":h("+",2),"-":h("-",2)};C={"*":h("*",2),"/":h("/",2),"%":h("%",2)};var f=q.prototype;f.addVar=function(a){x(this,
a);this.vars.push(a)};f.addFn=function(a,b){x(this,a);this.fns[a]=b};f.addConst=function(a,b){x(this,a);this.consts[a]=b};f.addAddOp=function(a,b){y(this,a,b);this.addops[a]=b};f.addMulOp=function(a,b){y(this,a,b);this.mulops[a]=b};f.isVarName=function(a){for(var b=0;b<this.vars.length;b++)if(this.vars[b]==a)return!0};f.isFnName=function(a){return this.fns.hasOwnProperty(a)};f.isConst=function(a){return this.consts.hasOwnProperty(a)};f.isAddOp=function(a){return this.addops.hasOwnProperty(a)};f.isMulOp=
function(a){return this.mulops.hasOwnProperty(a)};f.getFnVal=function(a){return this.isMulOp(a)?this.mulops[a]:this.isAddOp(a)?this.addops[a]:"_pow"==a?this._pow:"_negate"==a?this._negate:this.fns[a]};f.isValidId=function(a){return"string"==typeof a&&/^[A-Za-z_][A-Za-z_0-9]*$/.test(a)};f.isKnownId=function(a){return this.isFnName(a)||this.isConst(a)||this.isAddOp(a)||this.isMulOp(a)||this.isVarName(a)||a==this._powOpId};k=q;var i=function(a,b){if(!(this instanceof i))return new i(a,b);this.type=a;
this.val=b},l=function(a,b){if(!(this instanceof l))return new l(a,b);this.name=b;this.argCount=0;this.envVal=a.getFnVal(b)},r,I=function(a){if(0!==a.s.length){switch(a.s.charAt(0)){case "(":s(a);a.tokens.push(i("lp",void 0));a.s=a.s.substring(1);return;case ")":a.tokens.push(i("rp",void 0));a.s=a.s.substring(1);return;case ",":a.tokens.push(i("comma",void 0));a.s=a.s.substring(1);return;case "-":if("-"!=a.s.charAt(0))throw Error("Expected a minus");var b;0===a.tokens.length?b=!0:(b=a.tokens[a.tokens.length-
1],b="lp"==b.type||"addop"==b.type||"mulop"==b.type||"comma"==b.type||"pow"==b.type||"negate"==b.type);b?m(a,"negate","_negate"):m(a,"addop",a.env._subtractOpId);a.s=a.s.substring(1);return}if(D.test(a.s))a:{var c=D.exec(a.s);if(!c)throw Error("Expected an identifier");b=c[1];var c=c[2],e=E(a,b);if(e)s(a),a.tokens.push(e),a.s=c;else{if(!a.env.noImplicitMul&&1<b.length)for(;1<b.length;)if(c=b.charAt(b.length-1)+c,b=b.substr(0,b.length-1),e=E(a,b)){s(a);a.tokens.push(e);a.s=c;break a}throw Error("Unknown identifier "+
b);}}else if(G.test(a.s)){b=H.exec(a.s);if(!b)throw Error("Expected a number");s(a,!1);c=parseFloat(b[1]);a.tokens.push(i("num",c));a.s=b[2]}else try{b=a.s.charAt(0);c=a.env;if(c.isAddOp(b))m(a,"addop",b);else if(c.isMulOp(b))m(a,"mulop",b);else if(!c.noPowOp&&b==c._powOpId)m(a,"pow","_pow");else throw Error("Expected an operator");a.s=a.s.substring(1)}catch(d){throw Error("Invalid input: "+a.s);}}},m=function(a,b,c){c=l(a.env,c);a.tokens.push(i(b,c))},s=function(a,b){if(!(a.env.noImplicitMul||0===
a.tokens.length)){var c=a.tokens[a.tokens.length-1].type;("rp"==c||"var"==c||"const"==c||!1!==b&&"num"==c)&&m(a,"mulop",a.env._implicitMulOpId)}},E=function(a,b){var c,e=a.env;e.isFnName(b)?c=i("fn",l(a.env,b)):e.isConst(b)?c=i("const",e.consts[b]):e.isVarName(b)&&(c=i("var",b));return c},D=/^([A-Za-z_][A-Za-z_0-9]*)(.*)/,H=/^([0-9]*\.?[0-9]+)(.*)/,G=/^[0-9.]/;r=function(a,b){for(var c=b.replace(/\s/g,""),e=[],c={env:a,s:c,tokens:e};0<c.s.length;)I(c);return e};var t,u=function(a,b){for(var c=F(a,
b);0<b.length&&"addop"==b[0].type;)c=j(b.shift(),[c,F(a,b)]);return c},F=function(a,b){for(var c=v(a,b);0<b.length&&"mulop"==b[0].type;)c=j(b.shift(),[c,v(a,b)]);return c},v=function(a,b){var c;if(0===b.length)throw Error("Expected a factor");if("negate"==b[0].type)c=j(b.shift(),[v(a,b)]);else{a:{if(0===b.length)throw Error("Expected a datum");switch(b[0].type){case "var":case "num":case "const":c=j(b.shift());break a;case "fn":c=o(b,"fn","function name");var e=j(c,[]);o(b,"lp","left parenthesis",
"Functions must be followed by an opening parenthesis");if("rp"==b[0].type)b.shift();else{e.children.push(u(a,b));for(c.val.argCount++;"rp"!=b[0].type;)o(b,"comma","comma","Too few arguments to a function?"),e.children.push(u(a,b)),c.val.argCount++;o(b,"rp","right parenthesis","Too many arguments to a function?")}if(!a.noArityCheck)if(c.val.envVal.lengthIsMinimum){if(c.val.argCount<c.val.envVal.length)throw Error("Invalid number of arguments to "+c.val.name+": expected at least "+c.val.envVal.length+
" but got "+c.val.argCount);}else if(c.val.argCount!=c.val.envVal.length)throw Error("Invalid number of arguments to "+c.val.name+": expected "+c.val.envVal.length+" but got "+c.val.argCount);c=e;break a;case "lp":b.shift();c=u(a,b);o(b,"rp","right parenthesis","Mismatched parentheses");break a;default:throw Error("Expected a datum");}}0<b.length&&"pow"==b[0].type&&(c=j(b.shift(),[c,v(a,b)]))}return c},o=function(a,b,c,e){if(0===a.length||a[0].type!=b)throw a="Expected "+(c||b),e&&(a+=" - "+e),Error(a);
return a.shift()},j=function(a,b){if(!(this instanceof j))return new j(a,b);this.root=a;this.children=b};j.prototype.isLeaf=function(){return!this.children||0===this.children.length};j.prototype.isConstant=function(){var a;if(a="var"!=this.root.type)if(!(a=this.isLeaf()))a:{a=this.children;for(var b=0;b<a.length;b++)if(!a[b].isConstant()){a=!1;break a}a=!0}return a};t=function(a,b){var c=b.slice(),e=u(a,c);if(0<c.length)throw Error("Unexpected token(s) after end of expression");return e};var w,J=
function(a,b){var c;if(b.val instanceof l&&(b.val.envVal instanceof d||b.val.envVal instanceof h))return b.val.envVal.name;switch(b.type){case "num":case "const":return b.val.toString();case "var":return b.val;case "negate":case "pow":return'env["'+b.val.name+'"]';case "mulop":c="mulops";break;case "addop":c="addops";break;case "fn":c="fns"}return"env."+c+'["'+b.val.name+'"]'},n=function(a,b,c){var e=b.root.val instanceof l&&!(b.root.val.envVal instanceof h),d=b.root.val instanceof l&&b.root.val.envVal instanceof
h,g=J(a,b.root),f;e?g+="(":d&&(f=g,g="(");if(!1!==c&&b.isConstant())return(new Function("env","return "+n(a,b,!1)))(a).toString();if(d)if(1==b.children.length)g+=f+n(a,b.children[0]);else if(2==b.children.length)g+=n(a,b.children[0])+" "+f+" "+n(a,b.children[1]);else throw Error("Invalid parse tree; a native operator was specified with "+b.children.length+" arguments");else if(b.children)for(c=0;c<b.children.length;c++)g+=n(a,b.children[c]),e&&c!=b.children.length-1&&(g+=", ");if(e||d)g+=")";return g};
w=function(a,b){var c=a.vars.slice(0);c.unshift("env");c.push("return "+n(a,b)+";");var d=Function.apply(null,c);c.shift();return function(){var b=Array.prototype.slice.call(arguments);b.unshift(a);return d.apply(null,b)}};return{Expr:{compile:function(){var a,b;switch(arguments.length){case 0:throw Error("Invalid arguments");case 1:if("string"!=typeof arguments[0])throw Error("Invalid arguments");a=k();b=arguments[0];break;case 2:if("string"!=typeof arguments[1])throw Error("Invalid arguments");
b=arguments[1];if(arguments[0]instanceof k)a=arguments[0];else if("string"==typeof arguments[0])a=k(arguments[0].split(","));else if("[object Array]"===Object.prototype.toString.call(arguments[0]))a=k(arguments[0]);else throw Error("Invalid arguments");break;default:a=[];for(b=0;b<arguments.length-1;b++){if("string"!=typeof arguments[b])throw Error("Invalid arguments");a.push.apply(a,arguments[b].split(","))}if("string"!=typeof arguments[arguments.length-1])throw Error("Invalid arguments");a=k(a);
b=arguments[arguments.length-1]}return w(a,t(a,r(a,b)))},oneshot:function(a,b){var c,d=[];if(1==arguments.length){if("string"!=typeof a)throw Error("Invalid arguments");c=k();b=a}else{c=[];for(var f in a)a.hasOwnProperty(f)&&(c.push(f),d.push(a[f]));c=k(c)}return w(c,t(c,r(c,b))).apply(null,d)},Compile:w,NativeOp:h,NativeFn:d,Environment:k,Lex:r,Token:i,FnCall:l,Parse:t}}}();
